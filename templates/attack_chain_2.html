<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Attack Chain 2: XSS ‚Üí CSRF</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body data-bs-theme="dark">
<nav class="navbar navbar-expand-lg bg-body-tertiary mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="/"><i class="bi bi-shield-lock"></i> Web Security Demo</a>
    </div>
</nav>

<div class="container-fluid">
    <div class="card border-warning mb-4">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0"><i class="bi bi-link-45deg"></i> Interactive Chain 2: XSS ‚Üí CSRF Bypass</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle-fill"></i> Interactive: How XSS Defeats CSRF</h5>
                <p class="mb-0">XSS steals CSRF tokens. See vulnerable vs secure side-by-side.</p>
            </div>

            <h5 class="mb-3"><i class="bi bi-1-circle-fill"></i> Step 1: XSS</h5>
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-danger h-100">
                        <div class="card-header bg-danger text-white"><strong>üîì Vulnerable</strong></div>
                        <div class="card-body">
                            <form method="get">
                                <div class="mb-2">
                                    <label class="form-label small">Name:</label>
                                    <input type="text" class="form-control form-control-sm font-monospace" 
                                           name="xss_name" value="{{ xss_name or '' }}" placeholder="<script>alert('XSS')</script>">
                                </div>
                                <button type="submit" class="btn btn-sm btn-danger w-100"><i class="bi bi-bug"></i> Inject</button>
                            </form>
                            {% if xss_result %}
                            <div class="alert alert-dark mt-3 mb-0 small">
                                <strong>Output:</strong>
                                <div class="border p-2 mt-2 bg-white text-dark">{{ xss_result|safe }}</div>
                                <small class="text-warning">‚ö†Ô∏è Script executes!</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white"><strong>üîí Secure</strong></div>
                        <div class="card-body">
                            <form method="get">
                                <div class="mb-2">
                                    <label class="form-label small">Name:</label>
                                    <input type="text" class="form-control form-control-sm font-monospace" 
                                           name="xss_name" value="{{ xss_name or '' }}" placeholder="<script>alert('XSS')</script>">
                                </div>
                                <button type="submit" class="btn btn-sm btn-success w-100"><i class="bi bi-shield-check"></i> Test Secure</button>
                            </form>
                            {% if xss_secure_result %}
                            <div class="alert alert-dark mt-3 mb-0 small">
                                <strong>Output:</strong>
                                <div class="border p-2 mt-2 bg-white text-dark">{{ xss_secure_result|safe }}</div>
                                <small class="text-success">‚úÖ Displayed as text</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mb-3"><i class="bi bi-2-circle-fill"></i> Step 2: Token Theft</h5>
            <div class="card border-warning mb-4">
                <div class="card-body">
                    <p>XSS can steal CSRF tokens:</p>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-danger small">
                                <strong>Read Cookie:</strong>
                                <pre class="mb-0"><code>document.cookie</code></pre>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-danger small">
                                <strong>Extract Token:</strong>
                                <pre class="mb-0"><code>fetch('/secure').then(r=>r.text())</code></pre>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mb-0">Current token: <code>{{ demo_csrf_token }}</code></div>
                </div>
            </div>

            <h5 class="mb-3"><i class="bi bi-3-circle-fill"></i> Step 3: CSRF Attack</h5>
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-danger h-100">
                        <div class="card-header bg-danger text-white"><strong>üîì No CSRF Token</strong></div>
                        <div class="card-body">
                            <form method="get">
                                <input type="hidden" name="xss_name" value="{{ xss_name }}">
                                <div class="mb-2">
                                    <label class="form-label small">New Password:</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           name="csrf_password" value="{{ csrf_password or '' }}" placeholder="HACKED123">
                                </div>
                                <button type="submit" class="btn btn-sm btn-danger w-100"><i class="bi bi-key"></i> Change</button>
                            </form>
                            {% if csrf_result %}
                            <div class="alert alert-dark mt-3 mb-0 small">{{ csrf_result }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white"><strong>üîí Token Required</strong></div>
                        <div class="card-body">
                            <form method="get">
                                <input type="hidden" name="xss_name" value="{{ xss_name }}">
                                <input type="hidden" name="csrf_password" value="{{ csrf_password }}">
                                <div class="mb-2">
                                    <label class="form-label small">Token:</label>
                                    <input type="text" class="form-control form-control-sm font-monospace" 
                                           name="csrf_token" value="{{ csrf_token if csrf_token else 'wrong' }}">
                                </div>
                                <button type="submit" class="btn btn-sm btn-outline-success btn-sm w-100">Try Invalid</button>
                            </form>
                            <form method="get" class="mt-2">
                                <input type="hidden" name="xss_name" value="{{ xss_name }}">
                                <input type="hidden" name="csrf_password" value="{{ csrf_password }}">
                                <input type="hidden" name="csrf_token" value="{{ demo_csrf_token }}">
                                <button type="submit" class="btn btn-sm btn-success w-100">Try Valid</button>
                            </form>
                            {% if csrf_secure_result %}
                            <div class="alert alert-dark mt-3 mb-0 small">{{ csrf_secure_result }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <h6><i class="bi bi-lightbulb"></i> Key Points:</h6>
                <ul class="mb-0">
                    <li>XSS bypasses CSRF protection by stealing tokens</li>
                    <li>Fix XSS first - it defeats most client defenses</li>
                    <li>Defense: Escape output + CSRF tokens + CSP + HttpOnly cookies</li>
                </ul>
            </div>
            <a href="/" class="btn btn-primary mt-3">Back to Home</a>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
