<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Web Security Vulnerabilities Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS (CDN) -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    >
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script>
        // Theme handling - apply before page renders to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
        })();
    </script>

    <style>
        .card {
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            background-color: rgba(30, 30, 30, 0.75);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.125);
        }
        pre {
            background-color: #111;
            border: 1px solid #444;
        }
        .score-badge {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #000;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .gamification-bar {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .achievement-mini {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 3px;
            font-size: 1.2rem;
        }
        .achievement-mini.locked {
            background: #333;
            color: #666;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-body-tertiary mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="bi bi-shield-lock"></i>
            Web Security Vulnerabilities Demo
        </a>

        <div class="d-flex align-items-center gap-3">
            <!-- Theme Toggle -->
            <button class="btn btn-sm btn-outline-secondary" id="themeToggle" title="Toggle theme">
                <i class="bi bi-sun-fill" id="themeIcon"></i>
            </button>
            <a href="/quiz" class="btn btn-sm btn-outline-info" title="Test your knowledge">
                <i class="bi bi-question-circle-fill"></i> Quiz
            </a>
            <a href="/achievements" class="score-badge text-decoration-none">
                <i class="bi bi-trophy-fill"></i> {{ score }} pts
            </a>
            <span class="text-body-secondary small">
                Signed in as <strong>{{ user_email }}</strong>
            </span>
            <a class="btn btn-sm btn-outline-light" href="/logout">
                <i class="bi bi-box-arrow-right"></i>
                Logout
            </a>
        </div>
    </div>
</nav>

<div class="container">
    <!-- Gamification Status Bar -->
    <div class="gamification-bar">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h5 class="mb-2"><i class="bi bi-bar-chart-fill text-info"></i> Your Progress</h5>
                <div class="d-flex gap-3">
                    <div class="text-center">
                        <div class="progress" style="width: 80px; height: 10px;">
                            <div class="progress-bar bg-warning" style="width: {{ chain1_progress }}%;"></div>
                        </div>
                        <small class="text-muted">Chain 1</small>
                    </div>
                    <div class="text-center">
                        <div class="progress" style="width: 80px; height: 10px;">
                            <div class="progress-bar bg-info" style="width: {{ chain2_progress }}%;"></div>
                        </div>
                        <small class="text-muted">Chain 2</small>
                    </div>
                    <div class="text-center">
                        <div class="progress" style="width: 80px; height: 10px;">
                            <div class="progress-bar bg-success" style="width: {{ chain3_progress }}%;"></div>
                        </div>
                        <small class="text-muted">Chain 3</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <small class="text-muted">Recent Achievements</small>
                <div class="mt-1">
                    {% if 'first_blood' in achievements %}
                    <span class="achievement-mini bg-danger" title="First Blood"><i class="bi bi-droplet-fill"></i></span>
                    {% else %}
                    <span class="achievement-mini locked" title="First Blood (Locked)"><i class="bi bi-droplet"></i></span>
                    {% endif %}
                    {% if 'chain_master_1' in achievements %}
                    <span class="achievement-mini bg-warning text-dark" title="Chain 1 Master"><i class="bi bi-database-fill-lock"></i></span>
                    {% else %}
                    <span class="achievement-mini locked" title="Chain 1 Master (Locked)"><i class="bi bi-database"></i></span>
                    {% endif %}
                    {% if 'chain_master_2' in achievements %}
                    <span class="achievement-mini bg-info" title="Chain 2 Master"><i class="bi bi-person-fill-gear"></i></span>
                    {% else %}
                    <span class="achievement-mini locked" title="Chain 2 Master (Locked)"><i class="bi bi-person-gear"></i></span>
                    {% endif %}
                    {% if 'chain_master_3' in achievements %}
                    <span class="achievement-mini bg-success" title="Chain 3 Master"><i class="bi bi-pc-display-horizontal"></i></span>
                    {% else %}
                    <span class="achievement-mini locked" title="Chain 3 Master (Locked)"><i class="bi bi-pc-display"></i></span>
                    {% endif %}
                    {% if 'speed_runner' in achievements %}
                    <span class="achievement-mini bg-primary" title="Speed Runner"><i class="bi bi-lightning-fill"></i></span>
                    {% else %}
                    <span class="achievement-mini locked" title="Speed Runner (Locked)"><i class="bi bi-lightning"></i></span>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4 text-end">
                <a href="/achievements" class="btn btn-outline-warning btn-sm me-2">
                    <i class="bi bi-trophy"></i> All Achievements
                </a>
                <a href="/defense_guide" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-shield-check"></i> Defense Guide
                </a>
            </div>
        </div>
    </div>

    <!-- Attack Chains Section -->
    <div class="card border-warning mb-4" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0"><i class="bi bi-link-45deg"></i> ðŸŽ¯ Attack Chain Puzzles</h4>
        </div>
        <div class="card-body">
            <p class="text-warning mb-3">
                <i class="bi bi-exclamation-triangle-fill"></i> 
                <strong>Interactive Story-Driven Challenges:</strong> Each chain is a multi-stage puzzle where completing one stage unlocks the next!
            </p>
            <div class="row g-3">
                <!-- Chain 1 -->
                <div class="col-md-4">
                    <div class="card bg-dark border-danger h-100">
                        <div class="card-header bg-danger text-white">
                            <i class="bi bi-database-fill-lock"></i> <strong>The Database Heist</strong>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">
                                Break into MegaCorp's admin panel, explore their server, and steal their secrets!
                            </p>
                            <div class="small mb-2">
                                <span class="badge bg-secondary">1. SQL Injection</span>
                                <i class="bi bi-arrow-right text-muted"></i>
                                <span class="badge bg-secondary">2. Command</span>
                                <i class="bi bi-arrow-right text-muted"></i>
                                <span class="badge bg-secondary">3. Path</span>
                            </div>
                            <a href="/attack_chain_1" class="btn btn-outline-danger btn-sm w-100" target="_blank">
                                <i class="bi bi-play-fill"></i> Start Chain 1
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Chain 2 -->
                <div class="col-md-4">
                    <div class="card bg-dark border-info h-100">
                        <div class="card-header bg-info text-white">
                            <i class="bi bi-person-fill-gear"></i> <strong>The Identity Thief</strong>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">
                                Steal Alice's session cookie, hijack her identity, and take over her account!
                            </p>
                            <div class="small mb-2">
                                <span class="badge bg-secondary">1. XSS</span>
                                <i class="bi bi-arrow-right text-muted"></i>
                                <span class="badge bg-secondary">2. Session</span>
                                <i class="bi bi-arrow-right text-muted"></i>
                                <span class="badge bg-secondary">3. CSRF</span>
                            </div>
                            <a href="/attack_chain_2" class="btn btn-outline-info btn-sm w-100" target="_blank">
                                <i class="bi bi-play-fill"></i> Start Chain 2
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Chain 3 -->
                <div class="col-md-4">
                    <div class="card bg-dark border-success h-100">
                        <div class="card-header bg-success text-white">
                            <i class="bi bi-pc-display-horizontal"></i> <strong>The Server Explorer</strong>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">
                                Hijack a ping tool, map the filesystem, and exfiltrate secret data!
                            </p>
                            <div class="small mb-2">
                                <span class="badge bg-secondary">1. Recon</span>
                                <i class="bi bi-arrow-right text-muted"></i>
                                <span class="badge bg-secondary">2. Map</span>
                                <i class="bi bi-arrow-right text-muted"></i>
                                <span class="badge bg-secondary">3. Exfil</span>
                            </div>
                            <a href="/attack_chain_3" class="btn btn-outline-success btn-sm w-100" target="_blank">
                                <i class="bi bi-play-fill"></i> Start Chain 3
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-4">Individual Vulnerability Demonstrations</h2>

    <!-- Path Traversal Demo Section -->
    <div class="row">
        <div class="col-12">
            <h3 class="mb-3"><i class="bi bi-folder"></i> Path Traversal Demo</h3>
        </div>
        <!-- Vulnerable Section -->
        <div class="col-md-6">
            <div class="card border-danger-subtle">
                <div class="card-header">
                    <h4><i class="bi bi-radioactive"></i> Vulnerable Endpoint</h4>
                    <code>/view_vuln</code>
                </div>
                <div class="card-body">
                    <p>
                        This endpoint is vulnerable. It constructs a file path by joining user input directly,
                        without validating if the final path is inside the intended directory.
                    </p>

                    <h6>Quick Links</h6>
                    <div class="mb-2">
                        <a class="btn btn-sm btn-outline-danger"
                           href="/view_vuln?file=image.jpg"
                           target="_blank">
                            <i class="bi bi-image"></i> image.jpg
                        </a>
                        <a class="btn btn-sm btn-outline-danger"
                           href="/view_vuln?file=document.pdf"
                           target="_blank">
                            <i class="bi bi-file-earmark-pdf"></i> document.pdf
                        </a>
                    </div>

                    <hr>

                    <h6><i class="bi bi-bug"></i> Try the Exploit</h6>
                    <form method="get" action="/view_vuln" target="_blank" class="row g-2">
                        <div class="col-9">
                            <input type="text"
                                   class="form-control"
                                   name="file"
                                   value="../../secret/flag.txt">
                        </div>
                        <div class="col-3 d-grid">
                            <button type="submit" class="btn btn-danger">Hack It</button>
                        </div>
                    </form>

                    <p class="mt-2 text-muted small">
                        The path requires two `../` to get to the root before accessing `secret/flag.txt`.
                        Try finding `another_secret.txt` as well.<br>
                        <strong>ðŸ’¡ Hint:</strong> Try just <code>../../secret</code> (without a filename) to see directory listing!
                    </p>

                    <div class="mt-3">
                        <div class="code-title">Vulnerable Code</div>
                        <pre>
file = request.args.get("file")
path = os.path.join(PUBLIC_DIR, file)
# No validation is done!
return send_file(path)
</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secure Section -->
        <div class="col-md-6">
            <div class="card border-success-subtle">
                <div class="card-header">
                    <h4><i class="bi bi-shield-check"></i> Secure Endpoint</h4>
                    <code>/view_secure</code>
                </div>
                <div class="card-body">
                     <p>
                        This endpoint is secure. It validates the user-provided filename and ensures the final,
                        resolved path is safely within the `public/files` directory.
                    </p>

                    <h6>Quick Links</h6>
                    <div class="mb-2">
                        <a class="btn btn-sm btn-outline-success"
                           href="/view_secure?file=image.jpg"
                           target="_blank">
                            <i class="bi bi-image"></i> image.jpg
                        </a>
                        <a class="btn btn-sm btn-outline-success"
                           href="/view_secure?file=document.pdf"
                           target="_blank">
                           <i class="bi bi-file-earmark-pdf"></i> document.pdf
                        </a>
                    </div>

                    <hr>

                    <h6><i class="bi bi-send-slash"></i> Try the Exploit (it will fail)</h6>
                     <form method="get" action="/view_secure" target="_blank" class="row g-2">
                        <div class="col-9">
                            <input type="text"
                                   class="form-control"
                                   name="file"
                                   value="../../secret/flag.txt">
                        </div>
                        <div class="col-3 d-grid">
                            <button type="submit" class="btn btn-success">Attempt</button>
                        </div>
                    </form>
                     <p class="mt-2 text-muted small">
                        The backend will validate the path and return a 403 Forbidden error, preventing the exploit.
                    </p>
                    <div class="mt-3">
                        <div class="code-title">Secure Code</div>
                        <pre>
# Sanitize filename
safe_name = secure_filename(file)

# Get absolute path
abs_path = os.path.abspath(
    os.path.join(PUBLIC_DIR, safe_name)
)

# Check if path is inside PUBLIC_DIR
    abort(403) # Forbidden

return send_file(abs_path)
                        </pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SQL Injection Demo Section -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="mb-3"><i class="bi bi-database-x"></i> SQL Injection Demo</h3>
        </div>

        <!-- SQL Vulnerable -->
        <div class="col-md-6">
            <div class="card border-danger-subtle">
                <div class="card-header">
                    <h4><i class="bi bi-database-x"></i> Vulnerable SQL</h4>
                    <code>/sql_login_vuln</code>
                </div>
                <div class="card-body">
                    <p>
                        Login form that uses string concatenation for SQL queries, allowing injection attacks.
                    </p>

                    <h6>Quick Access</h6>
                    <div class="mb-2">
                        <a class="btn btn-sm btn-outline-danger"
                           href="/sql_login_vuln"
                           target="_blank">
                            <i class="bi bi-door-open"></i> Open Vulnerable Login
                        </a>
                    </div>

                    <hr>

                    <h6><i class="bi bi-bug"></i> SQL Injection Payloads</h6>
                    <p class="small text-muted mb-2">Try these in the email field:</p>
                    
                    <div class="mb-2">
                        <strong>Bypass authentication:</strong>
                        <code class="d-block bg-dark p-2 small">admin@example.com' OR '1'='1</code>
                    </div>

                    <div class="mb-2">
                        <strong>Comment out password:</strong>
                        <code class="d-block bg-dark p-2 small">admin@example.com'--</code>
                    </div>

                    <div class="mt-3">
                        <div class="code-title">Vulnerable Code</div>
                        <pre class="small">
query = f"SELECT * FROM users 
WHERE email = '{email}' 
AND password = '{password}'"
cursor.execute(query)
# User input directly in query!
</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- SQL Secure -->
        <div class="col-md-6">
            <div class="card border-success-subtle">
                <div class="card-header">
                    <h4><i class="bi bi-database-check"></i> Secure SQL</h4>
                    <code>/sql_login_secure</code>
                </div>
                <div class="card-body">
                    <p>
                        Login form using parameterized queries to prevent SQL injection.
                    </p>

                    <h6>Quick Access</h6>
                    <div class="mb-2">
                        <a class="btn btn-sm btn-outline-success"
                           href="/sql_login_secure"
                           target="_blank">
                            <i class="bi bi-shield-check"></i> Open Secure Login
                        </a>
                    </div>

                    <hr>

                    <h6><i class="bi bi-key"></i> Valid Credentials</h6>
                    <ul class="small mb-0">
                        <li>admin@example.com / admin123</li>
                        <li>user@example.com / user123</li>
                        <li>demo@example.com / password123</li>
                    </ul>

                    <p class="text-muted small mt-2">
                        SQL injection won't work - parameterized queries treat input as data, not code.
                    </p>

                    <div class="mt-3">
                        <div class="code-title">Secure Code</div>
                        <pre class="small">
# Parameterized query
cursor.execute(
    "SELECT * FROM users 
     WHERE email = ?",
    (email,)
)
# Input is safely escaped
</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Injection Demo Section -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="mb-3"><i class="bi bi-terminal"></i> Command Injection Demo</h3>
        </div>

        <!-- Command Vulnerable -->
        <div class="col-md-6">
            <div class="card border-danger-subtle">
                <div class="card-header">
                    <h4><i class="bi bi-terminal-x"></i> Vulnerable Command</h4>
                    <code>/cmd_search_vuln</code>
                </div>
                <div class="card-body">
                    <p>
                        File search using shell commands with unsanitized user input.
                    </p>

                    <h6>Quick Access</h6>
                    <div class="mb-2">
                        <a class="btn btn-sm btn-outline-danger"
                           href="/cmd_search_vuln"
                           target="_blank">
                            <i class="bi bi-search"></i> Open Vulnerable Search
                        </a>
                    </div>

                    <hr>

                    <h6><i class="bi bi-bug"></i> Command Injection Payloads</h6>
                    
                    <div class="mb-2">
                        <strong>Windows - List directory:</strong>
                        <code class="d-block bg-dark p-2 small">test & dir</code>
                    </div>

                    <div class="mb-2">
                        <strong>Windows - Read secret:</strong>
                        <code class="d-block bg-dark p-2 small">test & type secret\flag.txt</code>
                    </div>

                    <div class="mb-2">
                        <strong>Unix - List files:</strong>
                        <code class="d-block bg-dark p-2 small">test; ls -la</code>
                    </div>

                    <div class="mt-3">
                        <div class="code-title">Vulnerable Code</div>
                        <pre class="small">
cmd = f'dir /s /b *{pattern}*'
output = subprocess.check_output(
    cmd, 
    shell=True  # DANGER!
)
</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Command Secure -->
        <div class="col-md-6">
            <div class="card border-success-subtle">
                <div class="card-header">
                    <h4><i class="bi bi-shield-check"></i> Secure Command</h4>
                    <code>/cmd_search_secure</code>
                </div>
                <div class="card-body">
                    <p>
                        File search using Python's os.walk with input sanitization.
                    </p>

                    <h6>Quick Access</h6>
                    <div class="mb-2">
                        <a class="btn btn-sm btn-outline-success"
                           href="/cmd_search_secure"
                           target="_blank">
                            <i class="bi bi-shield-check"></i> Open Secure Search
                        </a>
                    </div>

                    <hr>

                    <h6><i class="bi bi-info-circle"></i> Protection Methods</h6>
                    <ul class="small mb-0">
                        <li>Input sanitization (alphanumeric only)</li>
                        <li>No shell=True in subprocess</li>
                        <li>Use Python's os.walk() instead</li>
                        <li>Limited to public directory</li>
                    </ul>

                    <p class="text-muted small mt-2">
                        Command injection payloads are sanitized before use.
                    </p>

                    <div class="mt-3">
                        <div class="code-title">Secure Code</div>
                        <pre class="small">
safe = "".join(
    c for c in pattern 
    if c.isalnum() or c in "._-"
)
for root, dirs, files in os.walk():
    # No shell commands!
</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CSRF Demo Section -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="mb-3"><i class="bi bi-shield-x"></i> CSRF (Cross-Site Request Forgery) Demo</h3>
        </div>

        <!-- CSRF Vulnerable -->
        <div class="col-md-6">
            <div class="card border-danger-subtle">
                <div class="card-header">
                    <h4><i class="bi bi-unlock"></i> Vulnerable CSRF</h4>
                    <code>/change_password_vuln</code>
                </div>
                <div class="card-body">
                    <p>
                        Password change form with no CSRF token protection.
                    </p>

                    <h6>Quick Access</h6>
                    <div class="mb-2">
                        <a class="btn btn-sm btn-outline-danger"
                           href="/change_password_vuln"
                           target="_blank">
                            <i class="bi bi-key"></i> Open Vulnerable Form
                        </a>
                    </div>

                    <hr>

                    <h6><i class="bi bi-bug"></i> CSRF Attack Demo</h6>
                    <p class="small text-muted mb-2">
                        While logged in, visit the malicious page:
                    </p>
                    
                    <div class="mb-2">
                        <a class="btn btn-sm btn-danger"
                           href="/csrf_attack"
                           target="_blank">
                            <i class="bi bi-exclamation-triangle"></i> Launch CSRF Attack
                        </a>
                    </div>

                    <p class="text-warning small">
                        The attack page will automatically change your password to "HACKED123"!
                    </p>

                    <div class="mt-3">
                        <div class="code-title">Vulnerable Code</div>
                        <pre class="small">
@app.route("/change_password")
def change_password():
    new_pwd = request.form.get("new_password")
    # No CSRF token check!
    update_password(new_pwd)
</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- CSRF Secure -->
        <div class="col-md-6">
            <div class="card border-success-subtle">
                <div class="card-header">
                    <h4><i class="bi bi-shield-check"></i> Secure CSRF</h4>
                    <code>/change_password_secure</code>
                </div>
                <div class="card-body">
                    <p>
                        Password change form with CSRF token validation.
                    </p>

                    <h6>Quick Access</h6>
                    <div class="mb-2">
                        <a class="btn btn-sm btn-outline-success"
                           href="/change_password_secure"
                           target="_blank">
                            <i class="bi bi-shield-check"></i> Open Secure Form
                        </a>
                    </div>

                    <hr>

                    <h6><i class="bi bi-info-circle"></i> CSRF Protection</h6>
                    <ul class="small mb-0">
                        <li>Hidden token in form</li>
                        <li>Token stored in session</li>
                        <li>Server validates token match</li>
                        <li>Token changes each request</li>
                    </ul>

                    <p class="text-muted small mt-2">
                        The attack page cannot forge the token, so the attack fails.
                    </p>

                    <div class="mt-3">
                        <div class="code-title">Secure Code</div>
                        <pre class="small">
token = request.form.get("csrf_token")
if token != session.get("csrf_token"):
    abort(403)
# Token validated!
update_password(new_pwd)
</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- XSS Demo Section -->
    <div class="row mt-4">
        <div class="col-12">
            <h3 class="mb-3"><i class="bi bi-code-slash"></i> XSS (Cross-Site Scripting) Demo</h3>
        </div>

        <!-- XSS Vulnerable -->
        <div class="col-md-6">
            <div class="card border-danger-subtle">
                <div class="card-header">
                    <h4><i class="bi bi-bug-fill"></i> Vulnerable XSS</h4>
                    <code>/xss_vuln</code>
                </div>
                <div class="card-body">
                    <p>
                        This page reflects user input directly into HTML without escaping, allowing JavaScript injection.
                    </p>

                    <h6>Quick Links</h6>
                    <div class="mb-2">
                        <a class="btn btn-sm btn-outline-danger"
                           href="/xss_vuln?name=John"
                           target="_blank">
                            Normal Input
                        </a>
                    </div>

                    <hr>

                    <h6><i class="bi bi-bug"></i> Try Cookie Theft</h6>
                    <form method="get" action="/xss_vuln" target="_blank" class="mb-3">
                        <div class="input-group input-group-sm">
                            <input type="text"
                                   class="form-control font-monospace small"
                                   name="name"
                                   value='<img src=x onerror="fetch(\'/steal?cookie=\'+document.cookie)">'>
                            <button type="submit" class="btn btn-danger">Inject</button>
                        </div>
                    </form>

                    <h6><i class="bi bi-bug"></i> Try Alert Popup</h6>
                    <form method="get" action="/xss_vuln" target="_blank" class="mb-3">
                        <div class="input-group input-group-sm">
                            <input type="text"
                                   class="form-control font-monospace small"
                                   name="name"
                                   value='<script>alert("XSS!")</script>'>
                            <button type="submit" class="btn btn-danger">Inject</button>
                        </div>
                    </form>

                    <h6><i class="bi bi-bug"></i> Phishing - Fake Signup Page</h6>
                    <form method="get" action="/xss_vuln" target="_blank">
                        <div class="input-group input-group-sm">
                            <input type="text"
                                   class="form-control font-monospace small"
                                   name="name"
                                   value='<script>window.location="/fake_signup"</script>'>
                            <button type="submit" class="btn btn-danger">Inject</button>
                        </div>
                    </form>
                    <p class="mt-2 text-muted small">
                        Redirects to a fake signup page that steals credentials and personal info.
                    </p>

                    <div class="mt-3">
                        <div class="code-title">Vulnerable Code</div>
                        <pre>
name = request.args.get("name")
html = f"&lt;h1&gt;Welcome, {name}!&lt;/h1&gt;"
# No escaping - JavaScript executes!
return html
</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- XSS Secure -->
        <div class="col-md-6">
            <div class="card border-success-subtle">
                <div class="card-header">
                    <h4><i class="bi bi-shield-check"></i> Secure XSS</h4>
                    <code>/xss_secure</code>
                </div>
                <div class="card-body">
                    <p>
                        This page uses Jinja2's auto-escaping to prevent JavaScript injection.
                    </p>

                    <h6>Quick Links</h6>
                    <div class="mb-2">
                        <a class="btn btn-sm btn-outline-success"
                           href="/xss_secure?name=John"
                           target="_blank">
                            Normal Input
                        </a>
                    </div>

                    <hr>

                    <h6><i class="bi bi-send-slash"></i> Try Injection (it will fail)</h6>
                    <form method="get" action="/xss_secure" target="_blank" class="mb-3">
                        <div class="input-group input-group-sm">
                            <input type="text"
                                   class="form-control font-monospace small"
                                   name="name"
                                   value='<script>alert("XSS!")</script>'>
                            <button type="submit" class="btn btn-success">Attempt</button>
                        </div>
                    </form>

                    <p class="text-muted small">
                        The injected script will be displayed as plain text instead of executing.
                    </p>

                    <div class="mt-3">
                        <div class="code-title">Secure Code</div>
                        <pre>
# Use Jinja2 template with auto-escaping
name = escape(request.args.get("name"))
return render_template(
    "xss_secure.html",
    name=name
)
# &lt;script&gt; becomes &amp;lt;script&amp;gt;
</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle (CDN) -->
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
></script>

<script>
// ==================== THEME TOGGLE ====================
document.addEventListener('DOMContentLoaded', function() {
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    
    function updateThemeIcon() {
        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
        themeIcon.className = currentTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
    }
    
    updateThemeIcon();
    
    themeToggle.addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-bs-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon();
    });
});

// ==================== PROGRESS PERSISTENCE ====================
(function() {
    const STORAGE_KEY = 'web_security_progress_backup';
    
    // Save progress to localStorage periodically
    function saveProgressToLocal() {
        const progress = {
            score: {{ score }},
            achievements: {{ achievements | tojson }},
            chain1_progress: {{ chain1_progress }},
            chain2_progress: {{ chain2_progress }},
            chain3_progress: {{ chain3_progress }},
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
    }
    
    // Check for local backup and show recovery option
    function checkLocalBackup() {
        const backup = localStorage.getItem(STORAGE_KEY);
        if (backup) {
            const data = JSON.parse(backup);
            const currentScore = {{ score }};
            
            // If session score is 0 but we have a backup with progress
            if (currentScore === 0 && data.score > 0) {
                showRecoveryBanner(data);
            }
        }
    }
    
    function showRecoveryBanner(data) {
        const banner = document.createElement('div');
        banner.className = 'alert alert-info alert-dismissible fade show position-fixed bottom-0 start-50 translate-middle-x mb-3';
        banner.style.zIndex = '9999';
        banner.style.maxWidth = '500px';
        banner.innerHTML = `
            <i class="bi bi-info-circle-fill"></i>
            <strong>Previous progress found!</strong><br>
            <small>Score: ${data.score} pts | Saved: ${new Date(data.timestamp).toLocaleString()}</small><br>
            <small class="text-muted">Note: Progress is session-based. This is a local backup only.</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(banner);
    }
    
    // Save on page load and periodically
    saveProgressToLocal();
    checkLocalBackup();
    
    // Show session warning on first visit
    if (!sessionStorage.getItem('session_warned')) {
        sessionStorage.setItem('session_warned', 'true');
        const toast = document.createElement('div');
        toast.className = 'toast show position-fixed bottom-0 end-0 m-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="toast-header bg-warning text-dark">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong class="me-auto">Session-Based Progress</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                Your progress is stored in your browser session. Closing the browser or logging out will reset progress.
                <br><small class="text-muted">A backup is saved locally for reference.</small>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 8000);
    }
})();
</script>

</body>
</html>
